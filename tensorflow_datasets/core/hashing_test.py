# coding=utf-8
# Copyright 2019 The TensorFlow Datasets Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Tests for tensorflow_datasets.core.hashing."""

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import string

from tensorflow_datasets import testing
from tensorflow_datasets.core import hashing

EXPECTED_ASCII_HASHES = [
    10863254463029944905, 17270894748891556580, 1421958803217889556,
    2755936516345535118, 10743397483099227609, 14847904966537228119,
    8418086691718335568, 11915783202300667430, 9716548853924804360,
    1754241953508342506, 3694815635762763843, 3596675173038026136,
    8070480893871644201, 10828895317094483299, 6744895540894632903,
    14841125270424448140, 17688157251436176611, 233329666533924104,
    12405195962649360880, 6834955004197680363, 13969673605019971927,
    7535964442537143799, 4233129741512941149, 6982149393400456965,
    6390938501586896152, 10691964138414231865, 2507792285634992701,
    8595505165718044977, 12668683514780208634, 4572719121647279127,
    3793178347273963799, 12176803637319179781, 8203705581228860887,
    6621546828295374121, 10489668860986262979, 2912571526136585784,
    7938998531316856084, 9873236742883981124, 11452724586647173125,
    17125311730203373552, 14019180516172084896, 4703666581826301487,
    855367633508639125, 14196452709219207778, 12230774050365420318,
    2537184170178946005, 7687283993009238581, 8820003036235826491,
    17283458755135480410, 17416811303727010451, 5922709015603821319,
    14428075881971433291]

EXPECTED_INT_HASHES = [
    13163753087252323914, 5003827105613308882, 11449545338359147399,
    3672830208859661989, 5406800756778728304, 14481025309921804611,
    1609946449970207933, 8255655750251093705, 8491335656787965458,
    614618433269745394, 13284406229155908416, 15288099744915406683,
    15843726386018726000, 5119555216682145351, 18142174963634300418,
    9628501536262262909, 6944376202371927192, 14434159142587098114,
    9198994799148619777, 10976198626365556062, 12201794547984161272,
    3793153257673850654, 17671034425519684114, 1052793885524652273,
    6624479012289984384, 8863054234635171593, 4965745346604460244,
    9391177234155550519, 4717670777148145883, 17524121804784260174,
    11037926627716248709, 6960985957824457329, 12195906204051370437,
    10975328135781691390, 5730073803446725122, 13712792850809427923,
    4455483863044151629, 3518672581294300691, 15747605586304671771,
    13668305533495453291, 4654232860820002596, 10574044313476412487,
    11212237458977771261, 15365614270461858889, 13872585532843456912,
    17241372482471269826, 3462651383276316179, 12647419365920702661,
    1995464140987078702, 1972561720831881829, 3955328643960597520,
    1027369990565220197, 11322815499836299743, 5956980248780520012,
    18278096046037631584, 5241067853637136955, 7630275157338448032,
    1913046367367276708, 7440126551217879907, 7220748048216444121,
    5064805925883037540, 1318705738537093225, 2730963110225791297,
    6920195161195209846, 4682001368639242156, 9166607120404080113,
    11268721706256216334, 5379201623047735445, 15999685243572303930,
    13046608731927560566, 16276928149450612660, 16298571539550440629,
    17035045450101282343, 14240119263724925078, 9965315260615748500,
    14921974451741066715, 3620887669157180415, 14499246414755411500,
    188410546870139183, 14101909720529780551, 1623775225152586541,
    1826999275929156985, 5289921295512723016, 151075781360207052,
    17598366794955569210, 1171265316432012145, 104641658363814304,
    9264688353594391671, 458105873437653640, 1830791798008018143,
    15150529348822956655, 7610023982731034430, 12031109555968877759,
    2814999125315447998, 14537302745610214253, 14150033554738292901,
    1316273336836242886, 4973610113424219627, 11435740729903845598,
    4598673630928554393]


class HashingTest(testing.TestCase):

  def _assert_hashes(self, keys, expected_hashes):
    hashes = [hashing.hash_key(k) for k in keys]
    self.assertEqual(hashes, expected_hashes)

  def test_ints(self):
    ints = list(range(100))
    hashing._CSIPHASH_AVAILABLE = False
    self._assert_hashes(ints, EXPECTED_INT_HASHES)
    # https://github.com/tensorflow/datasets/issues/737
    # hashing._CSIPHASH_AVAILABLE = True
    # self._assert_hashes(ints, EXPECTED_INT_HASHES)

  def test_ascii(self):
    letters = string.ascii_lowercase + string.ascii_uppercase
    hashing._CSIPHASH_AVAILABLE = False
    self._assert_hashes(letters, EXPECTED_ASCII_HASHES)
    # https://github.com/tensorflow/datasets/issues/737
    # hashing._CSIPHASH_AVAILABLE = True
    # self._assert_hashes(letters, EXPECTED_ASCII_HASHES)


if __name__ == '__main__':
  testing.test_main()
